---
## create the searchengine and elasticsearch folders


- name: Ensure sysctl is present
  ansible.builtin.package:
    name: procps-ng
    state: present
  become: true

- name: update curl and ca certificates
  ansible.builtin.dnf:
    name:
      - curl
      - ca-certificates
      # - requests
    state: latest
    allowerasing: true
  become: true


- name: Ensure python3-requests is installed
  ansible.builtin.package:
    name: python3-requests
    state: present
  become: yes


- name:  Import ome.docker role
  ansible.builtin.import_role:
    name: ome.docker
  #vars:
  #  docker_systemd_setup: false


- name: Check if a elastic node data folder exists
  ansible.builtin.stat:
    path: "{{ apps_folder }}/searchengine/elasticsearch/node1/data"
  register: elastic_node_data_folder

- name: Create app top level directory
  become: yes
  ansible.builtin.file:
    path: "{{ apps_folder }}/searchengine"
    recurse: yes
    state: directory
    owner: 1000
    group: root
    mode: 0755
  changed_when: false

- name: Create elasticsearch directory
  become: yes
  ansible.builtin.file:
    path: "{{ apps_folder }}/searchengine/elasticsearch"
    state: directory
    # User id in elasticsearch Docker image
    owner: 1000
    group: root
    mode: 0755
  changed_when: false


- name: Create elasticsearch certs folder
  become: yes
  ansible.builtin.file:
    path: "{{ apps_folder }}/searchengine/elasticsearch/certs"
    state: directory
    # User id in elasticsearch Docker image
    owner: 1000
    group: root
    mode: 0755
  changed_when: false


- name: Create elasticsearch main nodes directories
  become: yes
  ansible.builtin.file:
    path: "{{ apps_folder }}/searchengine/elasticsearch/node{{ item }}"
    state: directory
    # User id in elasticsearch Docker image
    owner: 1000
    group: root
    mode: 0755
  with_sequence: start=1 count={{ elasticsearch_no_nodes }}
  changed_when: false


- name: Create elasticsearch logs directory
  become: yes
  ansible.builtin.file:
    path: "{{ apps_folder }}/searchengine/elasticsearch/node{{ item }}/logs"
    state: directory
    # User id in elasticsearch Docker image
    owner: 1000
    group: root
    mode: 0755
  with_sequence: start=1 count={{ elasticsearch_no_nodes }}
  changed_when: false



- name: Create elasticsearch data directory
  become: yes
  ansible.builtin.file:
    path: "{{ apps_folder }}/searchengine/elasticsearch/node{{ item }}/data"
    state: directory
    # User id in elasticsearch Docker image
    owner: 1000
    group: root
    mode: 0755
  with_sequence: start=1 count={{ elasticsearch_no_nodes }}
  #changed_when: false
  when: not elastic_node_data_folder.stat.exists


- name: deploy elasticsearch cluster
  ansible.builtin.include_tasks: elasticsearch.yml
  when: not elastic_node_data_folder.stat.exists
  #elasticsearch.yml

- name: deploy nginx for the search engine
  ansible.builtin.import_tasks: nginx.yml

- name: deploy redis
  ansible.builtin.import_tasks: redis.yml

- name: deploy searchengine
  ansible.builtin.import_tasks: searchengine.yml

- name: check elasticsearch node2
  community.docker.docker_container_info:
    name: searchengine_elasticsearch_node1
  register: node1_log2


- name: display elasticsearch logs2
  debug:
    var: node1_log2

- name: check elasticsearch node3
  command: "docker  ps"
  register: node1_log3


- name: display elasticsearch logs3
  debug:
    var: node1_log3

- name: Check Elasticsearch
  ansible.builtin.command: 'curl -I  -k -u "elastic:my_password" https://127.0.0.1:9201/'
  register: elasticsearch_run
  until: elasticsearch_run.rc == 0
  retries: 12
  delay: 5
  when: not elastic_node_data_folder.stat.exists
