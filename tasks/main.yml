---
## create the searchengine and elasticsearch folders

- name: Ensure python3-requests is installed
  ansible.builtin.package:
    name: python3-requests
    state: present
  become: yes

- name: Ensure sysctl is present
  ansible.builtin.package:
    name: "{{ 'procps' if ansible_os_family == 'Debian' else 'procps-ng' }}"
    state: present
  become: true

- name: update curl and openssl
  dnf:
    name:
      - curl
      - ca-certificates
    state: latest

- name:  Import ome.docker role
  ansible.builtin.import_role:
    name: ome.docker


- name: Check if a elastic node data folder exists
  ansible.builtin.stat:
    path: "{{ apps_folder }}/searchengine/elasticsearch/node1/data"
  register: elastic_node_data_folder

- name: Create app top level directory
  become: yes
  ansible.builtin.file:
    path: "{{ apps_folder }}/searchengine"
    recurse: yes
    state: directory
    owner: 1000
    group: root
    mode: 0755
  changed_when: false

- name: Create elasticsearch directory
  become: yes
  ansible.builtin.file:
    path: "{{ apps_folder }}/searchengine/elasticsearch"
    state: directory
    # User id in elasticsearch Docker image
    owner: 1000
    group: root
    mode: 0755
  changed_when: false


- name: Create elasticsearch certs folder
  become: yes
  ansible.builtin.file:
    path: "{{ apps_folder }}/searchengine/elasticsearch/certs"
    state: directory
    # User id in elasticsearch Docker image
    owner: 1000
    group: root
    mode: 0755
  changed_when: false


- name: Create elasticsearch main nodes directories
  become: yes
  ansible.builtin.file:
    path: "{{ apps_folder }}/searchengine/elasticsearch/node{{ item }}"
    state: directory
    # User id in elasticsearch Docker image
    owner: 1000
    group: root
    mode: 0755
  with_sequence: start=1 count={{ elasticsearch_no_nodes }}
  changed_when: false


- name: Create elasticsearch logs directory
  become: yes
  ansible.builtin.file:
    path: "{{ apps_folder }}/searchengine/elasticsearch/node{{ item }}/logs"
    state: directory
    # User id in elasticsearch Docker image
    owner: 1000
    group: root
    mode: 0755
  with_sequence: start=1 count={{ elasticsearch_no_nodes }}
  changed_when: false


- name: Create elasticsearch data directory
  become: yes
  ansible.builtin.file:
    path: "{{ apps_folder }}/searchengine/elasticsearch/node{{ item }}/data"
    state: directory
    # User id in elasticsearch Docker image
    owner: 1000
    group: root
    mode: 0755
  with_sequence: start=1 count={{ elasticsearch_no_nodes }}
  #changed_when: false
  when: not elastic_node_data_folder.stat.exists


- name: deploy elasticsearch cluster
  ansible.builtin.include_tasks: org_elasticsearch.yml
  when: not elastic_node_data_folder.stat.exists
  #elasticsearch.yml

- name: deploy nginx for the search engine
  ansible.builtin.import_tasks: nginx.yml

- name: deploy redis
  ansible.builtin.import_tasks: redis.yml

- name: deploy searchengine
  ansible.builtin.import_tasks: searchengine.yml


